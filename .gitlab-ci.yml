stages:
  - prepare
  - test
  - build
  - push
  - deploy_staging
  - deploy_production

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY: registry.gitlab.com
  IMAGE_BACKEND: ${REGISTRY}/${CI_PROJECT_PATH}/backend
  IMAGE_FRONTEND: ${REGISTRY}/${CI_PROJECT_PATH}/frontend
  IMAGE_TAG: ${CI_COMMIT_SHA}
  IMAGE_TAG_LATEST: latest

# ============================================
# STAGE 1: PREPARE - Ki·ªÉm tra c·∫•u h√¨nh
# ============================================
prepare:
  stage: prepare
  image: alpine:latest
  script:
    - echo "üìã Ki·ªÉm tra c·∫•u h√¨nh..."
    - test -f docker-compose.prod.yml || (echo "‚ùå docker-compose.prod.yml kh√¥ng t·ªìn t·∫°i"; exit 1)
    - test -f Dockerfile.prod || (echo "‚ùå Dockerfile.prod kh√¥ng t·ªìn t·∫°i"; exit 1)
    - test -f .env.example || (echo "‚ùå .env.example kh√¥ng t·ªìn t·∫°i"; exit 1)
    - echo "‚úÖ T·∫•t c·∫£ file c·∫•u h√¨nh ƒë√£ s·∫µn s√†ng"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# STAGE 2: TEST - Unit tests & Linting
# ============================================
test_backend:
  stage: test
  image: node:18-alpine
  script:
    - echo "üß™ Ch·∫°y test Backend..."
    - npm ci
    - npm run lint || echo "‚ö†Ô∏è Linting warnings"
    - npm run test || echo "‚ö†Ô∏è M·ªôt s·ªë test failed"
  artifacts:
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 30 days
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

test_frontend:
  stage: test
  image: node:18-alpine
  script:
    - echo "üß™ Ch·∫°y test Frontend..."
    - cd frontend
    - npm ci
    - npm run lint || echo "‚ö†Ô∏è Linting warnings"
    - npm run test:ci || echo "‚ö†Ô∏è M·ªôt s·ªë test failed"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================
# STAGE 3: BUILD - X√¢y d·ª±ng Docker images
# ============================================
build_backend:
  stage: build
  image: docker:24-git
  services:
    - docker:24-dind
  before_script:
    - echo "üîê ƒêƒÉng nh·∫≠p Docker Registry..."
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $REGISTRY
  script:
    - echo "üî® Build Backend image..."
    - docker build -t $IMAGE_BACKEND:$IMAGE_TAG -t $IMAGE_BACKEND:$IMAGE_TAG_LATEST -f Dockerfile.prod .
    - echo "‚úÖ Backend image ƒë√£ ƒë∆∞·ª£c build th√†nh c√¥ng"
  after_script:
    - docker logout $REGISTRY
  only:
    - main
    - develop
    - tags

build_frontend:
  stage: build
  image: docker:24-git
  services:
    - docker:24-dind
  before_script:
    - echo "üîê ƒêƒÉng nh·∫≠p Docker Registry..."
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $REGISTRY
  script:
    - echo "üî® Build Frontend image..."
    - docker build -t $IMAGE_FRONTEND:$IMAGE_TAG -t $IMAGE_FRONTEND:$IMAGE_TAG_LATEST ./frontend -f ./frontend/Dockerfile
    - echo "‚úÖ Frontend image ƒë√£ ƒë∆∞·ª£c build th√†nh c√¥ng"
  after_script:
    - docker logout $REGISTRY
  only:
    - main
    - develop
    - tags

# ============================================
# STAGE 4: PUSH - ƒê·∫©y images l√™n Registry
# ============================================
push_images:
  stage: push
  image: docker:24-git
  services:
    - docker:24-dind
  before_script:
    - echo "üîê ƒêƒÉng nh·∫≠p Docker Registry..."
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $REGISTRY
  script:
    - echo "üì§ Build v√† push Backend image..."
    - docker build -t $IMAGE_BACKEND:$IMAGE_TAG -t $IMAGE_BACKEND:$IMAGE_TAG_LATEST -f Dockerfile.prod .
    - docker push $IMAGE_BACKEND:$IMAGE_TAG
    - docker push $IMAGE_BACKEND:$IMAGE_TAG_LATEST
    - echo "‚úÖ Backend image pushed"
    
    - echo "üì§ Build v√† push Frontend image..."
    - docker build -t $IMAGE_FRONTEND:$IMAGE_TAG -t $IMAGE_FRONTEND:$IMAGE_TAG_LATEST ./frontend -f ./frontend/Dockerfile
    - docker push $IMAGE_FRONTEND:$IMAGE_TAG
    - docker push $IMAGE_FRONTEND:$IMAGE_TAG_LATEST
    - echo "‚úÖ Frontend image pushed"
  after_script:
    - docker logout $REGISTRY
  only:
    - main
    - develop
    - tags

# ============================================
# STAGE 5: DEPLOY STAGING
# ============================================
deploy_staging:
  stage: deploy_staging
  image: alpine:latest
  before_script:
    - echo "üì¶ Chu·∫©n b·ªã k·∫øt n·ªëi SSH..."
    - apk add --no-cache openssh-client git
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$DEPLOY_SSH_KEY_STAGING" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST_STAGING >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "üöÄ Deploy t·ªõi Staging..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST_STAGING \
      "cd $DEPLOY_PATH_STAGING && \
       git pull origin develop && \
       cp .env.staging .env && \
       export IMAGE_TAG=$IMAGE_TAG && \
       export REGISTRY=$REGISTRY && \
       export IMAGE_BACKEND=$IMAGE_BACKEND && \
       export IMAGE_FRONTEND=$IMAGE_FRONTEND && \
       docker-compose -f docker-compose.prod.yml pull && \
       docker-compose -f docker-compose.prod.yml up -d && \
       docker-compose -f docker-compose.prod.yml logs -f --tail=30 backend"
    - echo "‚úÖ Deploy Staging th√†nh c√¥ng"
  environment:
    name: staging
    url: https://staging.quanlyminhchung.local
    auto_stop_in: 1 week
  only:
    - develop
  when: manual

# ============================================
# STAGE 6: DEPLOY PRODUCTION
# ============================================
deploy_production:
  stage: deploy_production
  image: alpine:latest
  before_script:
    - echo "üì¶ Chu·∫©n b·ªã k·∫øt n·ªëi SSH..."
    - apk add --no-cache openssh-client git
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "üöÄ Deploy t·ªõi Production..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST \
      "cd $DEPLOY_PATH && \
       git pull origin main && \
       cp .env.prod .env && \
       export IMAGE_TAG=$IMAGE_TAG && \
       export REGISTRY=$REGISTRY && \
       export IMAGE_BACKEND=$IMAGE_BACKEND && \
       export IMAGE_FRONTEND=$IMAGE_FRONTEND && \
       docker-compose -f docker-compose.prod.yml pull && \
       docker-compose -f docker-compose.prod.yml up -d && \
       docker-compose -f docker-compose.prod.yml logs -f --tail=50 backend"
    - echo "‚úÖ Deploy Production th√†nh c√¥ng"
  environment:
    name: production
    url: https://quanlyminhchung.local
    kubernetes:
      namespace: production
  only:
    - main
    - tags
  when: manual

# ============================================
# ROLLBACK - Quay l·∫°i phi√™n b·∫£n tr∆∞·ªõc
# ============================================
rollback_production:
  stage: deploy_production
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "‚èÆÔ∏è Rollback t·ªõi phi√™n b·∫£n tr∆∞·ªõc..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST \
      "cd $DEPLOY_PATH && \
       git log --oneline -5 && \
       git reset --hard HEAD~1 && \
       export IMAGE_TAG=\$(git rev-parse HEAD) && \
       export REGISTRY=$REGISTRY && \
       export IMAGE_BACKEND=$IMAGE_BACKEND && \
       export IMAGE_FRONTEND=$IMAGE_FRONTEND && \
       docker-compose -f docker-compose.prod.yml pull && \
       docker-compose -f docker-compose.prod.yml up -d"
    - echo "‚úÖ Rollback th√†nh c√¥ng"
  only:
    - main
  when: manual
